# Restaurant POS API Documentation

## Table of Contents
1. [Overview](#overview)
2. [Server Discovery & Connection](#server-discovery--connection)
3. [Authentication](#authentication)
4. [Staff Management](#staff-management)
   - [Clock Operations](#clock-operations)
   - [Staff Administration](#staff-administration)
5. [Catalog Management](#catalog-management)
6. [Order Management](#order-management)
7. [Payment Processing](#payment-processing)
8. [Discount Management](#discount-management)
9. [WebSocket Integration](#websocket-integration)
10. [System Administration](#system-administration)
11. [Error Handling](#error-handling)

## Important Notes
- All IDs are auto-generated by the backend
- Do not include ID fields in creation requests
- Use IDs returned from creation endpoints for subsequent operations
- Category IDs are always six digits (100000-999999)
- The order_number cycles between 1-99 and is managed by the backend

## Overview

The Restaurant POS API provides a comprehensive backend solution for restaurant management. This documentation details all available endpoints, their usage, and required permissions.

## Server Discovery & Connection

The POS server uses Zeroconf (Bonjour) for automatic discovery on the local network.

### Service Discovery
- **Service Type**: `_pos._tcp.local.`
- **Service Name**: `Restaurant POS Server._pos._tcp.local.`
- **Properties**:
  - `version`: Server version
  - `api`: HTTP API
  - `docs`: Documentation URL
  - `host`: Server hostname

### Discovering the Server
```python
from zeroconf import ServiceBrowser, Zeroconf

def on_service_found(zeroconf, service_type, name):
    info = zeroconf.get_service_info(service_type, name)
    if info:
        host = info.server
        port = info.port
        properties = info.properties
        api_url = f"http://{host}:{port}"
```

### Base URL
Once discovered, the server can be accessed at:
```
http://{HOST}:{PORT}
```

### Authentication
All authenticated endpoints require a PIN in the request header:
```
X-Staff-PIN: 1234
```

### Response Format
All responses follow this general structure:
```json
{
    "success": true/false,
    "data": {}, // Response data if successful
    "error": {} // Error details if unsuccessful
}
```

## Authentication

### Login
- **Endpoint**: `POST /auth/login`
- **Access**: Public
- **Description**: Authenticate staff member using PIN
- **Request Body**:
  ```json
  {
    "pin": "1234"  // 4-digit PIN
  }
  ```
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "id": "integer",
      "name": "string",
      "isAdmin": "boolean",
      "working": "boolean",
      "break": "boolean",
      "available": "boolean"
    }
  }
  ```

### Error Responses
- Invalid PIN:
  ```json
  {
    "success": false,
    "error": {
      "code": "invalid_pin",
      "message": "Invalid PIN provided"
    }
  }
  ```
- Staff Not Found:
  ```json
  {
    "success": false,
    "error": {
      "code": "not_found",
      "message": "No staff member found with this PIN"
    }
  }
  ```

## Staff Management

### Clock Operations

#### Clock In
- **Endpoint**: `POST /staff/clock-in`
- **Access**: Authenticated
- **Description**: Clock in for work
- **Request Body**: None (uses PIN from header)
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "shift_id": 000000,
      "clock_in": "datetime",
      "hourly_rate": 0.00,
      "current_earnings": 0.00
    }
  }
  ```

#### Clock Out
- **Endpoint**: `POST /staff/clock-out`
- **Access**: Authenticated
- **Description**: Clock out from work
- **Request Body**: None (uses PIN from header)
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "shift_id": 000000,
      "clock_out": "datetime",
      "total_hours": 0.00,
      "break_hours": 0.00,
      "total_earnings": 0.00
    }
  }
  ```

#### Start Break
- **Endpoint**: `POST /staff/break/start`
- **Access**: Authenticated
- **Description**: Start break period
- **Request Body**: None (uses PIN from header)
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "shift_id": 000000,
      "break_start": "datetime",
      "current_earnings": 0.00
    }
  }
  ```

#### End Break
- **Endpoint**: `POST /staff/break/end`
- **Access**: Authenticated
- **Description**: End break period
- **Request Body**: None (uses PIN from header)
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "shift_id": 000000,
      "break_end": "datetime",
      "break_duration": 0.00,
      "current_earnings": 0.00
    }
  }
  ```

#### Get Current Status
- **Endpoint**: `GET /staff/status`
- **Access**: Authenticated
- **Description**: Get current working status and earnings
- **Response**:
  ```json
  {
    "success": true,
    "data": {
      "is_working": true,
      "is_on_break": false,
      "current_shift": {
        "shift_id": 000000,
        "clock_in": "datetime",
        "break_start": "datetime",
        "break_end": "datetime",
        "current_earnings": 0.00,
        "hours_worked": 0.00,
        "break_hours": 0.00
      }
    }
  }
  ```

#### Error Responses for Clock Operations

##### Already Clocked In
```json
{
  "success": false,
  "error": {
    "code": "already_clocked_in",
    "message": "Staff member is already clocked in"
  }
}
```

##### Not Clocked In
```json
{
  "success": false,
  "error": {
    "code": "not_clocked_in",
    "message": "Staff member is not clocked in"
  }
}
```

##### Already On Break
```json
{
  "success": false,
  "error": {
    "code": "already_on_break",
    "message": "Staff member is already on break"
  }
}
```

##### Not On Break
```json
{
  "success": false,
  "error": {
    "code": "not_on_break",
    "message": "Staff member is not on break"
  }
}
```

### Staff Administration

#### List Staff
- **Endpoint**: `GET /staff/admin`
- **Access**: Admin (requires admin PIN)
- **Description**: Get all staff members
- **Query Parameters**:
  - `active`: boolean (filter by active status)
  - `working`: boolean (filter by working status)
- **Response**:
  ```json
  {
    "staff": [
      {
        "id": "integer",
        "name": "string",
        "isAdmin": "boolean",
        "working": "boolean",
        "break": "boolean",
        "available": "boolean",
        "current_shift": {
          "clock_in": "datetime",
          "break_start": "datetime",
          "current_earnings": "float"
        }
      }
    ]
  }
  ```

#### Create Staff
- **Endpoint**: `POST /staff/admin`
- **Access**: Admin (requires admin PIN)
- **Description**: Create new staff member
- **Request Body**:
  ```json
  {
    "name": "string",
    "pin": "1234",  // 4-digit PIN
    "hourly_rate": "float",
    "isAdmin": "boolean"
  }
  ```

#### Update Staff
- **Endpoint**: `PATCH /staff/{staff_id}`
- **Access**: Admin (requires admin PIN)
- **Description**: Update staff member details
- **Request Body**:
  ```json
  {
    "name": "string",
    "pin": "1234",  // 4-digit PIN (optional)
    "hourly_rate": "float",
    "isAdmin": "boolean",
    "available": "boolean"
  }
  ```

#### Get Staff Earnings
- **Endpoint**: `GET /staff/{staff_id}/earnings`
- **Access**: Admin or Self
- **Description**: Get staff earnings for a period
- **Query Parameters**:
  - `start_date`: string (YYYY-MM-DD)
  - `end_date`: string (YYYY-MM-DD)
- **Response**:
  ```json
  {
    "earnings": {
      "total_earnings": "float",
      "total_hours": "float",
      "break_hours": "float",
      "shifts": [
        {
          "date": "string",
          "clock_in": "datetime",
          "clock_out": "datetime",
          "break_hours": "float",
          "earnings": "float"
        }
      ]
    }
  }
  ```

#### Delete Staff
- **Endpoint**: `DELETE /staff/{staff_id}`
- **Access**: Admin
- **Description**: Deactivate staff member

## Catalog Management

### Categories

#### List Categories
- **Endpoint**: `GET /catalog/categories`
- **Access**: Authenticated
- **Response**:
  ```json
  {
    "categories": [
      {
        "name": "Wings",
        "sort_order": 000000,
        "category_id": 000000,
        "available": true
      }
    ]
  }
  ```

#### Create Category
- **Endpoint**: `POST /catalog/categories`
- **Access**: Admin
- **Request Body**:
  ```json
  {
    "name": "Beverages",
    "sort_order": 1,
    "available": true
  }
  ```
- **Response**:
  ```json
  {
    "category_id": 100001,
    "name": "Beverages",
    "sort_order": 1,
    "available": true
  }
  ```

### Items

#### List Items
- **Endpoint**: `GET /catalog/items`
- **Access**: Authenticated
- **Query Parameters**:
  - `category_id`: integer (6 digits)
- **Response**:
  ```json
  {
    "items": [
      {
        "name": "6 Wings",
        "item_id": 000000,
        "category_id": 000000,
        "reg_price": 10.00,
        "event_price": 15.00,
        "sort_order": 000000,
        "available": true,
        "mod_list_id": [000000, 000001, 000002]
      }
    ]
  }
  ```

#### Create Item
- **Endpoint**: `POST /catalog/items`
- **Access**: Admin
- **Request Body**:
  ```json
  {
    "name": "Cheeseburger",
    "category_id": 100001,  // Reference to existing category
    "reg_price": 8.99,
    "event_price": 10.99,
    "sort_order": 1,
    "available": true
  }
  ```

### Mod Lists

#### List Mod Lists
- **Endpoint**: `GET /catalog/modlists`
- **Access**: Authenticated
- **Response**:
  ```json
  {
    "mod_lists": [
      {
        "item_id": [000000, 000001],
        "name": "1st Sauce",
        "mod_list_id": 000000,
        "min_selections": 000000,
        "max_selections": 000000,
        "sort_order": 000000,
        "available": true,
        "mods": [
          {
            "name": "BBQ",
            "mod_price": 0.00,
            "sort_order": 000000,
            "available": true
          }
        ]
      }
    ]
  }
  ```

#### Create Mod List
- **Endpoint**: `POST /catalog/modlists`
- **Access**: Admin
- **Request Body**:
  ```json
  {
    "item_id": [000000],
    "name": "string",
    "min_selections": 000000,
    "max_selections": 000000,
    "sort_order": 000000,
    "mods": [
      {
        "name": "string",
        "mod_price": 0.00,
        "sort_order": 000000
      }
    ]
  }
  ```

## Order Management

### Create Order
- **Endpoint**: `POST /orders`
- **Access**: Authenticated
- **Request Body**:
  ```json
  {
    "items": [
      {
        "item_id": 000000,
        "quantity": 1,
        "mods": [
          {
            "mod_list_id": 000000,
            "mod_id": 000000
          }
        ]
      }
    ]
  }
  ```

### List Orders
- **Endpoint**: `GET /orders`
- **Access**: Authenticated
- **Query Parameters**:
  - `status`: string (open, closed, cancelled)
  - `date`: string (YYYY-MM-DD)
- **Response**:
  ```json
  {
    "orders": [
      {
        "order_id": "string",
        "status": "string",
        "items": [
          {
            "item_id": 000000,
            "quantity": 1,
            "mods": [
              {
                "mod_list_id": 000000,
                "mod_id": 000000
              }
            ]
          }
        ],
        "total": 0.00,
        "created_at": "datetime",
        "updated_at": "datetime",
        "staff_id": 000000
      }
    ]
  }
  ```

### Update Order
- **Endpoint**: `PATCH /orders/{order_id}`
- **Access**: Authenticated
- **Description**: Update order status or add/remove items

### Cancel Order
- **Endpoint**: `POST /orders/{order_id}/cancel`
- **Access**: Authenticated
- **Description**: Cancel an open order

## Payment Processing

### Process Payment
- **Endpoint**: `POST /payments/process`
- **Access**: Authenticated
- **Request Body**:
  ```json
  {
    "order_id": "integer",
    "amount": "float",
    "payment_method": "string",
    "payment_details": {}
  }
  ```

### Refund Payment
- **Endpoint**: `POST /payments/{payment_id}/refund`
- **Access**: Admin
- **Request Body**:
  ```json
  {
    "amount": "float",
    "reason": "string"
  }
  ```

## Discount Management

### List Discounts
- **Endpoint**: `GET /discounts`
- **Access**: Authenticated
- **Response**:
  ```json
  {
    "discounts": [
      {
        "id": "integer",
        "name": "string",
        "type": "string",
        "value": "float",
        "active": "boolean"
      }
    ]
  }
  ```

### Apply Discount
- **Endpoint**: `POST /orders/{order_id}/discount`
- **Access**: Authenticated
- **Request Body**:
  ```json
  {
    "discount_id": "integer"
  }
  ```

## WebSocket Integration

### Connect to WebSocket
- **Endpoint**: `WS /ws/{client_type}/{client_id}?pin=1234`
- **Access**: Authenticated (requires valid PIN)
- **Description**: Establish WebSocket connection for real-time updates

### Connection Example
```javascript
// Connect to WebSocket with PIN
const pin = "1234";  // Staff PIN
const ws = new WebSocket(`ws://${HOST}:${PORT}/ws/pos/${client_id}?pin=${pin}`);

// Handle connection open
ws.onopen = () => {
  console.log('Connected to POS server');
};

// Handle incoming messages
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  switch(data.type) {
    case 'order_created':
      handleNewOrder(data.order);
      break;
    case 'staff_status':
      updateStaffStatus(data.staff);
      break;
    // ... handle other event types
  }
};

// Handle errors
ws.onerror = (error) => {
  console.error('WebSocket error:', error);
};

// Handle connection close
ws.onclose = () => {
  console.log('Disconnected from POS server');
  // Implement reconnection logic with PIN
};
```

### Error Handling

#### Authentication Errors
```json
{
  "success": false,
  "error": {
    "code": "invalid_pin",
    "message": "Invalid PIN provided"
  }
}
```

#### Permission Errors
```json
{
  "success": false,
  "error": {
    "code": "admin_required",
    "message": "This operation requires admin privileges"
  }
}
```

## System Administration

### System Settings
- **Endpoint**: `GET /admin/settings`
- **Access**: Admin
- **Description**: Get system settings including timezone and order number format

### Update Settings
- **Endpoint**: `PATCH /admin/settings`
- **Access**: Admin
- **Request Body**:
  ```json
  {
    "timezone": "string",
    "order_number_format": "string"
  }
  ```

### System Health
- **Endpoint**: `GET /health`
- **Access**: Admin
- **Description**: Check system health status including database and WebSocket connections

## Error Handling

### Error Codes
- `400`: Bad Request - Invalid input
- `401`: Unauthorized - Authentication required
- `403`: Forbidden - Insufficient permissions
- `404`: Not Found - Resource doesn't exist
- `409`: Conflict - Resource conflict
- `500`: Internal Server Error

### Error Response Format
```json
{
    "success": false,
    "error": {
        "code": "string",
        "message": "string",
        "details": {}
    }
}
```

## Rate Limiting

- All endpoints are rate-limited to prevent abuse
- Rate limit headers are included in responses:
  ```
  X-RateLimit-Limit: requests per window
  X-RateLimit-Remaining: remaining requests
  X-RateLimit-Reset: window reset time
  ```

## Best Practices

1. Always include the PIN in the X-Staff-PIN header for authenticated requests
2. Keep PIN secure and never expose it in client-side code
3. For admin operations, ensure the PIN belongs to a staff member with isAdmin=true
4. Implement proper error handling for PIN validation and permissions
5. Use secure HTTPS connections in production
6. Handle network errors gracefully
7. Implement automatic reconnection for WebSocket with proper PIN handling

## Development Tools

### API Documentation
- Swagger UI: `/docs`
- ReDoc: `/redoc`
- OpenAPI Specification: `/openapi.json`

### Testing
- Test environment available at `/test`
- Test credentials:
  ```
  Username: test_admin
  Password: test_password
  ```

## Support

For technical support or feature requests, please contact:
- Email: support@example.com
- GitHub Issues: https://github.com/yourusername/restaurant-pos/issues 